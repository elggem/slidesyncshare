<html>
<head>
    <title>SlideSyncShare</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,200;1,300;1,400;1,600;1,700;1,900&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" href="style.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="./node_modules/js-yaml/dist/js-yaml.min.js"></script>
    <script src="./node_modules/marked/marked.min.js"></script>
    <script src='https://moodle.elggem.pub:8443/external_api.js'></script>
</head>

<body>
<div id="navbar">
		<span id="logo">SlideSyncShare<br><span id="name">Hello, {{ lti.nickname }}!</span></span>

    {% if 'Instructor' in lti.role %}
      <div id="buttonbar">
        <form id="slidesform">
          <input id="slidesfile" name="file" type="file" style="position: fixed; top: -100em"/>
        </form>
        <span class="button" onclick="triggerSlideUpload()">Upload Slides</span>
        <span class="button" onclick="previousSlide()">Previous Slide</span>
        <span class="button" onclick="nextSlide()">Next Slide</span>
      </div>
    {% endif %}

    <!-- Message Test field -->
    <!-- <input type="text" id="test">
    <button class="button" type="button" onclick="testmessage()">Test</button> -->
</div>

<div id="container">
    <div id="slides">
        <div id="slide">
            <!-- This gets it's content from javascript. -->
        </div>
    </div>

    <div id="videoconference">
          <!-- This gets it's content from javascript. -->
    </div>
</div>

<script>
    // Jitsi related logic.
    const domain = 'moodle.elggem.pub:8443';

    {#const domain = 'meet.jit.si'#}
    const options = {
        roomName: "{{ title }}",
        width: "100%",
        {#height: 350,#}
        parentNode: document.querySelector('#videoconference'),
        configOverwrite: { openBridgeChannel: 'datachannel' },
        userInfo: {
            email: "{{ lti.nickname }}",
            displayName: "{{ lti.nickname }}"
        }
    };
    const api = new JitsiMeetExternalAPI(domain, options);

    // jitsi message channel listener
    api.addEventListener('endpointTextMessageReceived', event=>receiveMessage(event));

    function receiveMessage(msg) {
      // check for prefix
      var type = msg.data.eventData.text.type;
      var payload =  msg.data.eventData.text.payload;

      switch (type) {
          case "slide":
            renderSlide(payload)
            break;

          default:
            console.log("unknown message received");
            break;
      }
    }

    // Test message functionality
    //api.addEventListener('endpointTextMessageReceived', event=>console.log("Msg received: ", event))
    // function testmessage(){
    //     const input = document.getElementById('test')
    //     api.executeCommand('sendEndpointTextMessage', '', input.value);
    // }
</script>


<script>
    // Slide rendering and synchronization logic.
    var slidesFile = null;
    var currentSlide = 0;

    // event listener
    document.getElementById('slidesfile').addEventListener('change', loadSlidedeckFromFile, false);

    function triggerSlideUpload() {
      var fileFormElem = document.getElementById('slidesfile');
      console.log(fileFormElem);
      fileFormElem.click();
    }

    function loadSlidedeckFromFile(file_evt) {
      var file = file_evt.target.files[0];
      var reader = new FileReader();

      reader.onload = function(evt) {
          if(evt.target.readyState != 2) return;
          if(evt.target.error) {
              alert('Error while reading file');
              return;
          }

          slidesFile = jsyaml.load(evt.target.result);
          currentSlide = 0;
          sendCurrentSlide();
      };
      reader.readAsText(file);
    }

    function previousSlide() {
        currentSlide -= 1
        if (currentSlide < 0) currentSlide = 0;
        sendCurrentSlide();
    }

    function nextSlide() {
        currentSlide += 1;
        if (currentSlide >= slidesFile.slides.length)
            currentSlide = slidesFile.slides.length - 1;
        sendCurrentSlide();
    }


    function sendCurrentSlide() {
        if (slidesFile != null) {
          var slide = slidesFile.slides[currentSlide];
          api.executeCommand('sendEndpointTextMessage', '', {type: "slide", payload: slide});
          renderSlide(slide);
        }
    }

    function renderSlide(s) {
        switch (s.type) {
            case "markdown":
                document.getElementById('slide').innerHTML = marked(s.content);
                break;

            case "poll":
                var h = marked("# " + s.title);
                for (var i = 0; i < s.answers.length; i++) {
                    h += "<div class=\'pollanswer\'><input type=\'checkbox\'> " + s.answers[i] + "</div>";
                }
                h += "<div class=\'pollbutton\'' onclick=\'nextSlide()\'>Submit</div>";
                document.getElementById('slide').innerHTML = h;
                break;

            case "quiz":
                var h = marked("# " + s.title);
                for (var i = 0; i < s.questions.length; i++) {
                    h += "<div class=\'pollanswer\'>" + s.questions[i].prompt + "<input type=\'textfield\' style=\'float: right\'> </div>";
                }

                h += "<div class=\'pollbutton\'' onclick=\'nextSlide()\'>Submit</div>";
                document.getElementById('slide').innerHTML = h;
                break;

            default:
                console.log("unknown slide type");
                break;
        }
    }


</script>

</body>
</html>
